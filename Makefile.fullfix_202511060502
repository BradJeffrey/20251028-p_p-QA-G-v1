
# ============================================================
#  sPHENIX Real Data QA Pipeline - Automated Workflow (Appended)
TIMESTAMP := $(shell date +"%Y%m%d%H%M")
OUTDIR := 20250928/out
DOCSDIR := 20250928/docs
.PHONY: run-qa update-latest generate-changelog full-push
run-qa:
	cd 20250928 && \
	root -l -b -q 'macros/extract_quick.C("lists/files.txt")' && \
	root -l -b -q 'macros/aggregate_per_run_v2.C("metrics.conf","entries")' && \
	root -l -b -q 'macros/plot_dashboard.C()'
generate-changelog:
	cd $(DOCSDIR) && \
	echo "# ğŸ§  sPHENIX QA Pipeline â€” Auto Changelog (Real Data)" > CHANGELOG_REALDATA_$(TIMESTAMP).md && \
	echo "**Generated:** $$(date)" >> CHANGELOG_REALDATA_$(TIMESTAMP).md && \
	echo "" >> CHANGELOG_REALDATA_$(TIMESTAMP).md && \
	echo "## Pipeline outputs in $(OUTDIR)" >> CHANGELOG_REALDATA_$(TIMESTAMP).md && \
	ls -1 ../out | grep metrics_ >> CHANGELOG_REALDATA_$(TIMESTAMP).md && \
	echo "## Commit Summary" >> CHANGELOG_REALDATA_$(TIMESTAMP).md && \
	git log -1 --oneline >> CHANGELOG_REALDATA_$(TIMESTAMP).md
update-latest:
	latest=$$(ls -t CHANGELOG_REALDATA_*.md | head -n1) && \
	cp $$latest CHANGELOG_LATEST.md
	git add $(DOCSDIR)/CHANGELOG_LATEST.md
	git commit -m "Update CHANGELOG_LATEST.md to $$latest" || true
	git push origin results/intt-metrics
full-push: run-qa generate-changelog update-latest
	git add $(OUTDIR) $(DOCSDIR)/CHANGELOG_REALDATA_$(TIMESTAMP).md
	git commit -m "Automated QA run + changelog ($(TIMESTAMP))"
# ------------------------------------------------------------
# Add NaN detection to changelog generation
nan-check:
	@echo "ğŸ” Checking for NaN values in CSV metrics..."
	@cd $(OUTDIR) && \
	count=$$(grep -i "nan" metrics_*.csv | wc -l); \
	if [ "$$count" -gt 0 ]; then \
		echo "âš ï¸  Warning: $$count NaN entries detected in metrics CSVs."; \
		cd ../$(DOCSDIR) && \
		latest=$$(ls -t CHANGELOG_REALDATA_*.md | head -n1); \
		echo "" >> $$latest; \
		echo "âš ï¸  **Warning:** One or more metrics contain NaN values (detected automatically)." >> $$latest; \
	else \
		echo "âœ… No NaN values detected."; \
	fi
# Extend full-push to include NaN check
full-push: run-qa generate-changelog nan-check update-latest
	git push origin results-intt-metrics
# Improved nan-check: list affected CSVs with NaNs
	files_with_nan=$$(grep -il "nan" metrics_*.csv || true); \
	count=$$(echo "$$files_with_nan" | wc -w); \
		echo "âš ï¸  Warning: $$count metrics files contain NaNs."; \
		cd ../docs && \
		echo "Affected files:" >> $$latest; \
		echo "$$files_with_nan" | sed 's/^/- /' >> $$latest; \
