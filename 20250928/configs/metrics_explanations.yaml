intt_adc_peak:
  formula: argmax_x ADC(x)
  patterns: "Slow drift\u2192aging/temperature; step change\u2192calibration or hardware swap."
  physics: Peak ADC location tracks gain; shifts indicate gain drift or calibration shifts.
  why: Stability across run number implies consistent amplification; jumps/drifts are red flags.
intt_adc_median_p50:
  formula: quantile(ADC, 0.5)
  patterns: "Tracks peak but less sensitive to tail structure; step changes indicate gain shifts."
  physics: Median ADC value reflects typical signal amplitude, robust to outlier bins.
  why: Complements peak; median is less affected by noise tails or rare high-ADC hits.
intt_adc_p90:
  formula: quantile(ADC, 0.9)
  patterns: "Sensitive to high-end tail growth; broadening indicates noise or pickup."
  physics: 90th percentile of ADC spectrum probes the upper tail where noise and signal overlap.
  why: A rising p90 without a corresponding peak shift suggests growing electronic noise or crosstalk.
intt_phi_uniform_r1:
  formula: KS p-value vs uniform
  patterns: "Low p-value indicates non-uniform phi coverage; sudden drops flag dead or noisy sectors."
  physics: Cluster azimuthal distribution should be uniform for an isotropic source; deviations indicate dead/hot channels.
  why: Kolmogorov-Smirnov test quantifies departure from ideal uniformity in a single number.
intt_phi_chi2_reduced:
  formula: chi2/NDF vs uniform
  patterns: "Values near 1.0 indicate uniformity; large values flag localized excess or deficit."
  physics: Reduced chi-squared of phi distribution against a flat reference; sensitive to bin-level deviations.
  why: More sensitive than KS to localized structure (e.g., a single hot ladder) rather than broad shape changes.
intt_bco_peak:
  formula: argmax_b BCO(b)
  patterns: "Alternating offsets\u2192phase toggling; monotone drift\u2192clock drift."
  physics: Aligns timing to bunch crossing; shifts suggest clock/phase issues.
  why: Run-dependent offsets reveal timing misalignment.
cluster_size_intt_mean:
  formula: mean(clusterSize)
  patterns: "Stable around 1.5-3 strips; increase indicates noise or threshold drift."
  physics: Average number of strips per cluster reflects charge sharing and threshold settings.
  why: Growing cluster size suggests lowered thresholds or increased noise; shrinking suggests over-threshold or efficiency loss.
cluster_phi_intt_rms:
  formula: RMS(clusterPhi)
  patterns: "Should be approximately constant for uniform illumination; narrowing or broadening flags acceptance changes."
  physics: RMS of azimuthal cluster distribution measures the spread of hits around the detector.
  why: A stable RMS confirms consistent geometric acceptance; changes indicate dead regions or beam position shifts.
intt_hits_asym:
  formula: (max_occ - min_occ) / (max_occ + min_occ)
  patterns: "Values near 0 indicate balanced occupancy; approaching 1 flags extreme imbalance."
  physics: Asymmetry between most and least occupied sensors measures detector balance.
  why: High asymmetry indicates dead or noisy sensors creating occupancy hotspots or holes.

# --- INTT Physics QA Metrics (extracted by physqa_extract.C) ---

intt_adc_landau_mpv:
  formula: Landau fit MPV in [q10, q90] window
  patterns: "Tracks silicon sensor gain; drift indicates temperature or radiation effects."
  physics: Most probable value of Landau fit to ADC distribution; direct probe of MIP energy loss in silicon.
  why: More precise than maxbin for tracking gain; sensitive to calibration changes and sensor degradation.

intt_bco_mod_r1:
  formula: First Fourier harmonic amplitude R1 of BCO distribution
  patterns: "Near zero for uniform BCO; large R1 flags periodic structure."
  physics: Quantifies first-harmonic modulation of beam-clock offset distribution.
  why: Non-zero R1 reveals periodic timing structure; increasing R1 indicates growing synchronization issues.

intt_sensor_occupancy_median:
  formula: median(sensor occupancy histogram)
  patterns: "Stable for consistent beam conditions; drops indicate detector efficiency loss."
  physics: Median sensor occupancy measures typical hit rate across INTT sensors.
  why: Tracks overall INTT activity level; sudden changes indicate luminosity shifts or readout problems.

# --- MVTX Chip Health Metrics ---

mvtx_deadchip_frac_l0:
  formula: "N(occ < 0.05*median) / N(chips) for MVTX Layer 0"
  patterns: "Stable near 0; step increases indicate chip failures."
  physics: Fraction of MVTX Layer 0 chips classified as dead based on occupancy.
  why: Dead chips reduce tracking coverage; sudden increases flag hardware failures.

mvtx_hotchip_frac_l0:
  formula: "N(occ > 5*median) / N(chips) for MVTX Layer 0"
  patterns: "Stable near 0; spikes indicate noisy chips."
  physics: Fraction of MVTX Layer 0 chips classified as hot (noisy) based on occupancy.
  why: Hot chips inject fake hits degrading track reconstruction quality.

mvtx_deadchip_frac_l1:
  formula: "N(occ < 0.05*median) / N(chips) for MVTX Layer 1"
  patterns: "Stable near 0; step increases indicate chip failures."
  physics: Fraction of MVTX Layer 1 chips classified as dead.
  why: Layer 1 is critical for primary vertex reconstruction.

mvtx_hotchip_frac_l1:
  formula: "N(occ > 5*median) / N(chips) for MVTX Layer 1"
  patterns: "Stable near 0; spikes indicate noisy chips."
  physics: Fraction of MVTX Layer 1 chips classified as hot.
  why: Hot chips on Layer 1 degrade vertex resolution.

mvtx_deadchip_frac_l2:
  formula: "N(occ < 0.05*median) / N(chips) for MVTX Layer 2"
  patterns: "Stable near 0; step increases indicate chip failures."
  physics: Fraction of MVTX Layer 2 (outermost) chips classified as dead.
  why: Dead chips reduce tracking seed efficiency.

mvtx_hotchip_frac_l2:
  formula: "N(occ > 5*median) / N(chips) for MVTX Layer 2"
  patterns: "Stable near 0; spikes indicate noisy chips."
  physics: Fraction of MVTX Layer 2 chips classified as hot.
  why: Hot chips on outer layer increase combinatorial background.

# --- TPC Laser Timing Metrics ---

tpc_laser_time_mean_north:
  formula: "Weighted Gaussian-fit mean across 24 TPC laser lines (North)"
  patterns: "Very stable; drifts indicate field cage or gas changes."
  physics: Average laser time-sample position for TPC North; measures electron drift velocity.
  why: Drift velocity changes indicate gas, temperature, or electric field variations.

tpc_laser_time_mean_south:
  formula: "Weighted Gaussian-fit mean across 24 TPC laser lines (South)"
  patterns: "Should track North side; divergence flags asymmetric conditions."
  physics: Average laser time-sample position for TPC South endcap.
  why: N-S comparison reveals asymmetric field cage or gas flow issues.

tpc_laser_time_delta_NS:
  formula: "tpc_laser_time_mean_south - tpc_laser_time_mean_north"
  patterns: "Near zero and stable; drifts indicate asymmetric drift conditions."
  physics: North-South laser timing difference in TPC.
  why: Non-zero delta indicates asymmetric E-field, gas, or temperature gradient.

# --- TPC Cluster Shape and Resolution Metrics ---

tpc_phisize_ring_slope_avg:
  formula: "Average slope of mean phi-cluster-size vs ring (R0,R1,R2)"
  patterns: "Near zero for uniform conditions; non-zero indicates radial effects."
  physics: Radial dependence of phi cluster size in TPC.
  why: Reveals diffusion, gain, or gas condition gradients across TPC radius.

tpc_zsize_ring_slope_avg:
  formula: "Average slope of mean z-cluster-size vs ring (R0,R1,R2)"
  patterns: "Non-zero slope expected from drift-length diffusion."
  physics: Radial dependence of z cluster size in TPC.
  why: Z-size slope reflects longitudinal diffusion; changes indicate gas or field shifts.

tpc_resolution_rphi_mean:
  formula: "Mean of rphi_error histogram across rings 0-2"
  patterns: "Stable for consistent alignment and gas conditions."
  physics: Average rphi spatial resolution of TPC clusters.
  why: Resolution degradation indicates misalignment, gas contamination, or gain issues.

tpc_resolution_z_mean:
  formula: "Mean of z_error histogram across rings 0-2"
  patterns: "Stable for consistent drift conditions."
  physics: Average z spatial resolution of TPC clusters.
  why: Z resolution is sensitive to drift velocity uniformity and timing calibration.

tpc_sector_adc_uniform_chi2:
  formula: "chi2/NDF of sector ADC counts vs uniform (24 sectors, 3 rings)"
  patterns: "Near 1.0 for good uniformity; high values flag sector problems."
  physics: Reduced chi-squared of TPC sector occupancy vs flat reference.
  why: High chi2 indicates dead sectors, gain variations, or DAQ channel failures.
